import React, { SyntheticEvent } from "react";
import styled from "styled-components";
import Loadable from "react-loadable";

import { Textarea } from "./TextareaEditor";
import { Preview } from "./Preview";
import { Outline } from "./Outline";
import { Help } from "./Help";
import { ToolMode, EditorMode } from "../../types";
import { editor } from "monaco-editor";

const Loading = () => (
  <div style={{ color: "#fff", paddingLeft: 20 }}>Loading...</div>
);

const CodeMirrorEditor = Loadable({
  loader: () => import("./CodeMirrorEditor"),
  loading: () => <Loading />
});

const MonacoEditor = Loadable({
  loader: () => import("./MonacoEditor"),
  loading: () => <Loading />
});

export const Main = React.memo(function Main({
  editorRef,
  html,
  raw,
  editorMode,
  toolMode,
  outline,
  onChangeToolMode,
  onChangeValue,
  onSelectOutlineHeading,
  onWheel,
  previewContainerRef,
  showPreview
}: {
  html: string;
  raw: string;
  editorMode: EditorMode;
  toolMode: ToolMode;
  showPreview: boolean;
  outline: Array<any>;
  editorRef: React.RefObject<HTMLTextAreaElement>;
  previewContainerRef: React.RefObject<HTMLDivElement>;
  onChangeToolMode: (value: ToolMode) => void;
  onChangeValue: (value: string) => void;
  onSelectOutlineHeading: (offset: number) => void;
  onWheel: (event: SyntheticEvent<HTMLTextAreaElement>) => void;
}) {
  return (
    <>
      <Container>
      <h1 className="header-title">
        <a href="/" className="header-link">
          <svg viewBox='0 0 360 60' className="header-logo">
              <g id='logo' fill='none' fillRule='nonzero'>
                  <path d='M346.57324,24.5443038 C350.011762,24.5443038 352.820654,25.1484074 355,26.3566329 L355,39.1126413 L347.88084,39.1126413 L347.88084,31.2359803 C347.541831,31.1895101 347.033325,31.1662754 346.355306,31.1662754 C342.626204,31.1662754 339.587273,32.0491961 337.238423,33.815064 C334.889573,35.5809319 333.715165,38.1135203 333.715165,41.4129051 L333.715165,54.7962582 L344.32126,54.7962582 L344.32126,61 L318.532468,61 L318.532468,54.7962582 L326.305428,54.7962582 L326.305428,31.5148002 L318.532468,31.5148002 L318.532468,25.3807634 L333.206654,25.3807634 L333.206654,31.2359803 C334.368972,29.1912912 336.197173,27.5648583 338.691313,26.3566329 C341.185453,25.1484074 343.812735,24.5443038 346.57324,24.5443038 Z'
                  id='r' fill='#FFF' />
                  <path d='M307.136364,40.3446114 C307.136364,42.1427985 307.066388,43.6333787 306.926435,44.8163965 L282.294856,44.8163965 C282.808017,47.8449223 283.892635,50.2345825 285.548744,51.985449 C287.204853,53.7363154 289.362427,54.6117355 292.021531,54.6117355 C295.147145,54.6117355 297.852859,53.5233754 300.138756,51.3466225 L304.267344,55.8893884 C300.908476,59.2964798 296.803254,61 291.951555,61 C286.773299,61 282.691402,59.2373298 279.705742,55.7119366 C276.720081,52.1865434 275.227273,47.6083329 275.227273,41.9771679 C275.227273,36.0620786 276.731743,31.4247181 279.74073,28.0649474 C282.749716,24.7051766 286.81995,23.0253165 291.951555,23.0253165 C296.383395,23.0253165 300.022115,24.4922366 302.867823,27.4261209 C305.713531,30.3600052 307.136364,34.6661256 307.136364,40.3446114 Z M282.064935,38.2151899 L301.058442,38.2151899 C300.911204,34.8243022 300.003255,32.3310398 298.334567,30.735328 C296.665878,29.1396161 294.678205,28.3417722 292.371489,28.3417722 C289.328586,28.3417722 286.948287,29.2019477 285.230519,30.9223245 C283.512752,32.6427014 282.457568,35.0736322 282.064935,38.2151899 Z'
                  id='e' fill='#FFF' />
                  <path d='M222.406675,15.8101266 C218.328531,15.8101266 216.28949,17.2124735 216.28949,20.0172095 L216.28949,23.9341488 L228.30006,23.9341488 L228.30006,30.3173091 L216.28949,30.3173091 L216.28949,54.5443038 L226.435065,54.5443038 L226.435065,61 L200.772727,61 L200.772727,54.5443038 L208.829508,54.5443038 L208.829508,30.3173091 L200.772727,30.3173091 L200.772727,23.9341488 L208.829508,23.9341488 L208.829508,18.6390272 C208.829508,16.849799 209.177637,15.3265601 209.873905,14.0692647 C210.570174,12.8119693 211.539962,11.8569226 212.783298,11.2040961 C214.026635,10.5512697 215.319685,10.079791 216.662489,9.78964585 C218.005292,9.49950075 219.447541,9.35443038 220.989278,9.35443038 C224.221953,9.35443038 227.106451,9.93471188 229.642857,11.0952923 L229.642857,17.2608448 C227.355118,16.2936945 224.943081,15.8101266 222.406675,15.8101266 Z'
                  id='f' fill='#FFF' />
                  <path d='M261.913168,15.8101266 C257.835024,15.8101266 255.795983,17.2124735 255.795983,20.0172095 L255.795983,23.9341488 L267.806554,23.9341488 L267.806554,30.3173091 L255.795983,30.3173091 L255.795983,54.5443038 L265.941558,54.5443038 L265.941558,61 L240.279221,61 L240.279221,54.5443038 L248.336001,54.5443038 L248.336001,30.3173091 L240.279221,30.3173091 L240.279221,23.9341488 L248.336001,23.9341488 L248.336001,18.6390272 C248.336001,16.849799 248.68413,15.3265601 249.380399,14.0692647 C250.076667,12.8119693 251.046455,11.8569226 252.289792,11.2040961 C253.533128,10.5512697 254.826179,10.079791 256.168982,9.78964585 C257.511786,9.49950075 258.954034,9.35443038 260.495772,9.35443038 C263.728447,9.35443038 266.612944,9.93471188 269.149351,11.0952923 L269.149351,17.2608448 C266.861611,16.2936945 264.449575,15.8101266 261.913168,15.8101266 Z'
                  id='f' fill='#FFF' />
                  <path d='M169.792208,61 C160.562724,61 155.948052,55.7954147 155.948052,45.3860881 L155.948052,24.5443038 L163.230655,24.5443038 L163.230655,44.8981533 C163.230655,48.1975381 163.963715,50.6023353 165.429857,52.1126171 C166.895998,53.6228989 168.830796,54.3780284 171.234307,54.3780284 C176.954664,54.3780284 179.8148,51.2645712 179.8148,45.0375632 L179.8148,24.5443038 L187.097403,24.5443038 L187.097403,60.1635404 L179.8148,60.1635404 L179.8148,56.6782922 C177.507429,59.5594451 174.166598,61 169.792208,61 Z'
                  id='u' fill='#FFF' />
                  <path d='M111.123377,61 L111.123377,10.8734177 L126.901086,10.8734177 C132.472542,10.8734177 136.506985,12.1385045 139.004534,14.6687161 C141.502084,17.1989277 142.75084,20.3497099 142.75084,24.1211573 C142.75084,29.0861008 140.421429,32.5710569 135.762539,34.5761302 C138.500238,35.4354473 140.649539,36.927295 142.210507,39.0517179 C143.771476,41.1761408 144.551948,43.6705101 144.551948,46.5349005 C144.551948,50.5450472 143.219141,53.9583946 140.553487,56.7750452 C137.887834,59.5916958 133.697297,61 127.981751,61 L111.123377,61 Z M118.720779,31.3797468 L126.082177,31.3797468 C129.403498,31.3797468 131.919237,30.7294046 133.629469,29.4287006 C135.339702,28.1279966 136.194805,26.3242172 136.194805,24.0173082 C136.194805,19.3053239 133.344461,16.9493671 127.643686,16.9493671 L118.720779,16.9493671 L118.720779,31.3797468 Z M119.480519,54.164557 L129.707792,54.164557 C132.873392,54.164557 135.125805,53.4428734 136.465097,51.9994845 C137.80439,50.5560957 138.474026,48.7759428 138.474026,46.6589724 C138.474026,41.0297559 134.821465,38.2151899 127.516234,38.2151899 L119.480519,38.2151899 L119.480519,54.164557 Z'
                  id='B' fill='#FFF' />
                  <path d='M81.8733766,61 C81.3273373,61 80.8632109,60.7215218 80.4809834,60.164557 L65.2706537,36.654207 C64.9430301,36.1529387 64.7792208,35.790917 64.7792208,35.568131 C64.7792208,34.7883803 65.1614425,34.3985108 65.9258975,34.3985108 C66.2535211,34.3985108 66.6084413,34.4820543 66.9906688,34.6491437 L78.3514409,40.6987342 L77.4504806,2.51898734 L86.2962726,2.51898734 L85.3953123,40.6987342 L96.7560845,34.6491437 C97.138312,34.4820543 97.5205337,34.3985108 97.9027612,34.3985108 C98.6126123,34.3985108 98.9675325,34.7883803 98.9675325,35.568131 C98.9675325,35.7352205 98.8310247,36.0972422 98.5580051,36.654207 L83.2657698,60.164557 C82.9381462,60.7215218 82.4740198,61 81.8733766,61 Z'
                  id='â†“' fill='#0E9DD4' />
                  <g id='M' transform='translate(4 1)'>
                      <path d='M43.257989,57.2730042 L35.67476,34.0253165 L27.3506494,59.5443038 L19.0265387,34.0253165 L11.4286471,57.3179547 C9.97940178,56.2821352 8.63743991,55.0735127 7.4027584,53.6920857 C2.46756146,48.1703261 0,40.6214604 0,31.045262 C0,21.4690637 2.46756146,13.9008914 7.4027584,8.34051816 C12.3379553,2.78014492 18.9871858,0 27.3506494,0 C35.7141129,0 42.3633434,2.78014492 47.2985403,8.34051816 C52.2337372,13.9008914 54.7012987,21.4304506 54.7012987,30.9294215 C54.7012987,40.5056199 52.2149009,48.0737921 47.2420307,53.6341654 C46.0216208,55.0197502 44.693608,56.232696 43.257989,57.2730042 Z'
                      id='Path' fill='#0E9DD4' />
                      <g id='LeftEye' transform='translate(30.77 14.582)'>
                          <path d='M7.87367178,11.5681533 C7.05741784,12.7674495 5.95235215,13.3670886 4.55844156,13.3670886 C3.16453097,13.3670886 2.05632589,12.7716137 1.23379307,11.5806459 C0.411260243,10.3896782 0,8.76149146 0,6.69603691 C0,4.63058236 0.411260243,2.99823148 1.23379307,1.79893529 C2.05632589,0.5996391 3.16453097,0 4.55844156,0 C5.95235215,0 7.06055723,0.5996391 7.88309005,1.79893529 C8.70562287,2.99823148 9.11688312,4.62225404 9.11688312,6.6710517 C9.11688312,8.73650625 8.70248348,10.3688571 7.87367178,11.5681533 Z'
                          id='WhiteEye' fill='#FFF' />
                          <path d='M4.92104486,11.0071217 C4.41088615,11.7703102 3.72022009,12.1518987 2.84902597,12.1518987 C1.97783186,12.1518987 1.28520368,11.7729601 0.771120667,11.0150716 C0.257037652,10.257183 0,9.22106418 0,7.90668402 C0,6.59230385 0.257037652,5.55353511 0.771120667,4.79034662 C1.28520368,4.02715814 1.97783186,3.64556962 2.84902597,3.64556962 C3.72022009,3.64556962 4.41284827,4.02715814 4.92693128,4.79034662 C5.4410143,5.55353511 5.69805195,6.58700401 5.69805195,7.89078434 C5.69805195,9.2051645 5.43905218,10.2439332 4.92104486,11.0071217 Z'
                          id='BlackEye' fill='#2B2B2B' />
                      </g>
                      <g id='RightEye' transform='translate(12.536 14.582)'>
                          <path d='M7.87367178,11.5681533 C7.05741784,12.7674495 5.95235215,13.3670886 4.55844156,13.3670886 C3.16453097,13.3670886 2.05632589,12.7716137 1.23379307,11.5806459 C0.411260243,10.3896782 0,8.76149146 0,6.69603691 C0,4.63058236 0.411260243,2.99823148 1.23379307,1.79893529 C2.05632589,0.5996391 3.16453097,0 4.55844156,0 C5.95235215,0 7.06055723,0.5996391 7.88309005,1.79893529 C8.70562287,2.99823148 9.11688312,4.62225404 9.11688312,6.6710517 C9.11688312,8.73650625 8.70248348,10.3688571 7.87367178,11.5681533 Z'
                          id='WhiteEye' fill='#FFF' />
                          <path d='M4.92104486,11.0071217 C4.41088615,11.7703102 3.72022009,12.1518987 2.84902597,12.1518987 C1.97783186,12.1518987 1.28520368,11.7729601 0.771120667,11.0150716 C0.257037652,10.257183 0,9.22106418 0,7.90668402 C0,6.59230385 0.257037652,5.55353511 0.771120667,4.79034662 C1.28520368,4.02715814 1.97783186,3.64556962 2.84902597,3.64556962 C3.72022009,3.64556962 4.41284827,4.02715814 4.92693128,4.79034662 C5.4410143,5.55353511 5.69805195,6.58700401 5.69805195,7.89078434 C5.69805195,9.2051645 5.43905218,10.2439332 4.92104486,11.0071217 Z'
                          id='BlackEye' fill='#2B2B2B' />
                      </g>
                  </g>
              </g>
          </svg>
        </a>
      </h1>
        <Centered>
          <EditorContainer>
            {editorMode === "monaco" && (
              <MonacoEditor
                value={raw}
                width={showPreview ? "50vw" : "100vw"}
                onChangeValue={onChangeValue}
              />
            )}
            {editorMode === "codemirror" && (
              <CodeMirrorEditor value={raw} onChangeValue={onChangeValue} />
            )}
            {editorMode === "textarea" && (
              <Textarea
                ref={editorRef}
                raw={raw}
                onChangeValue={onChangeValue}
                onWheel={onWheel}
              />
            )}
          </EditorContainer>
        </Centered>
      </Container>
      {showPreview && (
        <SideTools>
          <ToolTabsContainer>
            {["preview", "outline", "help"].map(mode => {
              return (
                <TabButton
                  key={mode}
                  selected={mode === toolMode}
                  onClick={() => onChangeToolMode(mode as any)}
                  className="tab"
                >
                  {mode}
                </TabButton>
              );
            })}
          </ToolTabsContainer>
          <PreviewContainer ref={previewContainerRef}>
            {toolMode === "preview" && <Preview html={html} />}
            {toolMode === "outline" && (
              <OutlineContainer>
                <Outline
                  outline={outline}
                  onSelectOutlineHeading={onSelectOutlineHeading}
                />
              </OutlineContainer>
            )}
            {toolMode === "help" && <Help />}
          </PreviewContainer>
        </SideTools>
      )}
    </>
  );
});

const OutlineContainer = styled.div`
  line-height: 2rem;
`;

const Container = styled.div`
  flex: 1;
  height: 100vh;
`;

const Centered = styled.div`
  width: 100%;
  display: flex;
  justify-content: center;
`;

const EditorContainer = styled.div`
  width: 100%;
  max-width: 960px;
  margin-top: 1rem;
  margin-left: auto;
  margin-right: auto;
  padding-top: 8px;
`;

const SideTools = styled.div`
  flex: 1 1 0%;
  height: 100vh;
`;

const ToolTabsContainer = styled.div`
  display: felx;
  height: 2.4rem
  padding-left: 0.5rem;
  color: white;
  letter-spacing: 0.02rem;
  background: #273842;
  font-size: 0.8rem;
`;

const PreviewContainer = styled.div`
  display: flex;
  height: calc(100vh - 2.5rem);
  width: calc(100vw / 2);
  padding: 2rem;
  color: #263842;
  overflow-x: auto;
  overflow-y: auto;
  background: white;
  border-radius: 3px;
`;

const TabButton = styled.div<{ selected: boolean }>`
  display: flex;
  border-top: ${(p: any) => (p.selected ? "4px solid #3f9dd4" : "none")};
  background: ${(p: any) => (p.selected ? "rgba(255,255,255,.8)" : "none")};
  color: ${(p: any) => (p.selected ? "#273842" : "rgba(255,255,255,.5)")};
  cursor: ${(p: any) => (p.selected ? "auto" : "pointer")};
  margin-top: 2px;
  padding: 0 1.2rem;
  min-width: 80px;
  font-family: 'Roboto Mono', monospace;
  font-weight: bold;
  border-radius: 2px 2px 0 0;
  align-items: center;
  justify-content: center;
`;
